services:
  test:
    image: "buildkite/plugin-tester"
    volumes:
      - ".:/plugin"

  lint:
    image: "buildkite/plugin-linter"
    command: ['--id', 'wayfair-incubator/cloud-functions']
    volumes:
      - ".:/plugin"

  shfmt:
    build:
      context: .
      dockerfile: "docker/shfmt.dockerfile"
    command: "-s -l -w ." # (s)implify, (l)ist changes, (w)rite changes to file
    volumes:
      - "./hooks:/plugin"

  cloud-functions-buildkite-plugin: &cloud-functions-buildkite-plugin
    build:
      dockerfile: "docker/devbox.dockerfile"
      context: .
    image: wayfairossdev/cloud-functions-buildkite-plugin:${IMAGE_VERSION:-latest}
    environment:
      - gcp_project=wf-gcp-us-ae-ops-dev
      - dataset_schema_directory=junk/test
    volumes:
      - "./:/app"

  devbox: &devbox
    build:
      dockerfile: "./docker/devbox.dockerfile"
      context: "."
    stdin_open: true # docker run -i
    tty: true        # docker run -t
    volumes:
      - "./:/app"

  # Python 3.14 development box (when available)
  devbox-py314:
    build:
      dockerfile: "./docker/devbox-py314.dockerfile"
      context: "."
    stdin_open: true # docker run -i
    tty: true        # docker run -t
    volumes:
      - "./:/app"

  # Run all the tests and linting locally
  py-test:
    <<: *devbox
    command: "docker/run_tests.sh --format-code"
    volumes:
      - "./:/app"

  # Run ruff linter (check mode)
  ruff-check:
    <<: *devbox
    command: "ruff check plugin_scripts tests"
    volumes:
      - "./:/app"

  # Run ruff linter (fix mode)
  ruff-lint:
    <<: *devbox
    command: "ruff check --fix plugin_scripts tests"
    volumes:
      - "./:/app"

  # Run ruff formatter (check mode)
  ruff-format-check:
    <<: *devbox
    command: "ruff format --check plugin_scripts tests"
    volumes:
      - "./:/app"

  # Run ruff formatter (format mode)
  ruff-format:
    <<: *devbox
    command: "ruff format plugin_scripts tests"
    volumes:
      - "./:/app"

  # Run mypy type checking
  mypy:
    <<: *devbox
    command: "mypy plugin_scripts tests"
    volumes:
      - "./:/app"

  lock-requirements:
    <<: *devbox
    entrypoint: "/bin/bash"
    user: root
    command: "docker/lock_requirements.sh"

volumes:
  home:
  env:
    driver: local
